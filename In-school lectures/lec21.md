# Lec21: 异常处理
## 概述
错误通常包括语法错误和逻辑错误
运行异常（Exception）指程序设计对程序运行环境考虑不周而造成的程序运行错误。
在程序运行环境正常的情况下，运行异常的错误是不会出现的。
导致程序运行异常的情况是可以预料的，但它是无法避免的。
为了保证程序的**鲁棒性**（Robustness），必须在程序中对可能出现的异常错误进行**预见性处理**。

对于这些异常，就需要异常处理，包括：
- 发现异常，对可能出现的异常情况进行检测
- 处理异常，对检测到的异常进行处理。包括 就地处理：在发现异常的地方处理异常 和异地处理：在其它地方（非异常发现地）处理异常

### 就地处理
调用C++标准库中的函数exit或abort终止程序执行
- abort立即终止程序的执行，不作任何的善后处理工作。
- exit在终止程序的运行前，会做关闭被程序打开的文件、调用全局对象和static存储类的局部对象的析构函数（注意：不要在这些对象类的析构函数中调用exit）等工作。

```cpp
void f(char *filename)
{	ifstream file(filename);
	if (file.fail()) //发现异常
  { cerr << "文件打开失败\n";
	  exit(-1);	//处理异常
  }
  int x;
  cin >> x;
  ......
}
```

### 异地处理
一种解决途径：
通过函数的返回值，或指针/引用类型的参数，或全局变量把该函数执行中碰到的异常情况通知函数的调用者。
函数的调用者根据函数**返回的异常情况来处理异常**。
```cpp
int f(char *filename)
{ ifstream file(filename);
   if (file.fail()) 
     return -1; //把错误情况告诉调用者
   int x;
   cin >> x;   
   ......
   return 0; //函数正常返回
}
int main()
{  char str[100];
    ......
    int rc=f(str);
    if (rc== -1) //调用者根据返回值确定是否有异常
    { ...... //处理异常
    }
	 else
	 { ...... //正常情况
	 }
    ......
}
```
该途径有不足：
- 通过函数的返回值返回异常情况会导致正常返回值和异常返回值交织在一起，**有时无法区分**。
- 通过指针/引用类型的参数返回异常情况，需要引入**额外的参数**，给函数的使用带来负担。
- 通过全局变量返回异常情况会导致使用者会忽略这个全局变量的问题。（不知道它的存在）
- 程序的**可读性差**！程序的正常处理代码与异常处理代码混杂在一起，不能显式地区分它们。

另一种解决异常的异地处理途径：通过语言提供的结构化异常处理机制进行处理

## C++结构化异常处理机制
把有可能出现异常的**一系列操作**（语句或函数调用）放在一个`try`语句块中。
如果try语句块中的某个操作在执行中发现了异常，则通过执行一个`throw`语句生成一个**异常对象**，接在throw之后的操作不再进行。
生成的异常对象由程序中能够处理这个异常的地方通过`catch`语句块来**捕获并处理**。
```cpp
void f(char *filename)
{ ifstream file(filename);
   if (file.fail()) 
     throw filename; //生成异常对象
   int x;
   cin >> x;
   ......
   return;
} 
int main()
{  char str[100];
    ......
    try { f(str); } //启动异常处理机制
    catch (char *fn) //捕获异常对象
    { ...... //处理异常
    }
    ...... //正常情况
}
```

### try语句
启动（激活）异常处理机制

### throw语句
p18

### catch语句
